@page "/"
@using System.Text.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using SharedDump.Models.YouTube
@using SharedDump.Models.GitHub
@using SharedDump.Models.Reddit
@using FeedbackWebApp.Components.Feedback
@using FeedbackWebApp.Components.Feedback.Services
@using SharedDump.Utils
@inject IConfiguration Configuration
@inject HttpClient Http
@inject FeedbackServiceProvider ServiceProvider
@inject IJSRuntime JSRuntime

<PageTitle>FeedbackFlow</PageTitle>

<div class="min-vh-100">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand">🔄 FeedbackFlow</span>
        </div>
    </nav>

    <div class="container">
        @if (!isAuthenticated)
        {
            <AuthenticationForm OnAuthenticated="HandleAuthenticated" />
        }
        else
        {
            <div class="mb-5">
                <h2 class="h4 mb-4 text-center">Select Feedback Source</h2>
                <SourceSelector @bind-SelectedSource="selectedSource" />
            </div>

            @if (!string.IsNullOrEmpty(selectedSource))
            {
                <div class="card shadow-sm">
                    <div class="card-body">
                        @if (selectedSource == "YouTube")
                        {
                            <YouTubeInputForm @ref="youtubeInput"/>
                        }
                        else if (selectedSource == "HackerNews")
                        {
                            <HackerNewsInputForm @ref="hackerNewsInputForm" />
                        }
                        else if (selectedSource == "GitHub")
                        {
                            <GitHubInputForm @ref="githubInputForm" />
                        }
                        else if (selectedSource == "Reddit")
                        {
                            <RedditInputForm @ref="redditInputForm" />
                        }

                        <SubmitButton ShowWhenSource="@selectedSource" IsLoading="@isLoading" OnSubmit="SubmitFeedbackRequest" />
                        
                        @if (isLoading)
                        {
                            <div class="alert alert-info mt-3">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div>
                                        <strong>@currentStatus</strong>
                                        <div class="small">@currentStatusMessage</div>
                                    </div>
                                </div>
                            </div>
                        }

                        <AnalysisResults Error="@error" MarkdownResult="@markdownResult" />
                        
                        <YouTubeComments Videos="@youtubeVideos" />
                        
                        <GitHubFeedback Issues="@githubIssues" PullRequests="@githubPullRequests" Discussions="@githubDiscussions" />

                        <RedditComments Threads="@redditThreads" />
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private YouTubeInputForm? youtubeInput;
    private HackerNewsInputForm? hackerNewsInputForm;
    private GitHubInputForm? githubInputForm;
    private RedditInputForm? redditInputForm;
    private string selectedSource = "";
    private string markdownResult = "";
    private string error = "";
    private bool isLoading = false;
    private bool isAuthenticated = false;
    private List<YouTubeOutputVideo>? youtubeVideos;
    private List<GithubIssueModel>? githubIssues;
    private List<GithubIssueModel>? githubPullRequests;
    private List<GithubDiscussionModel>? githubDiscussions;
    private List<RedditThreadModel>? redditThreads;
    private FeedbackProcessStatus currentStatus;
    private string currentStatusMessage = "";

    private void HandleAuthenticated(bool success)
    {
        isAuthenticated = success;
        StateHasChanged();
    }

    private void HandleStatusUpdate(FeedbackProcessStatus status, string message)
    {
        currentStatus = status;
        currentStatusMessage = message;
        StateHasChanged();
    }

    private async Task SubmitFeedbackRequest()
    {
        try
        {
            // Reset all previous data
            error = "";
            markdownResult = "";
            youtubeVideos = null;
            githubIssues = null;
            githubPullRequests = null;
            githubDiscussions = null;
            redditThreads = null;
            isLoading = true;

            IFeedbackService service = selectedSource switch
            {
                "YouTube" => ServiceProvider.CreateYouTubeService(
                    youtubeInput?.VideoIds ?? string.Empty, 
                    youtubeInput?.PlaylistIds ?? string.Empty, 
                    HandleStatusUpdate),
                "HackerNews" => ServiceProvider.CreateHackerNewsService(
                    hackerNewsInputForm?.Value ?? string.Empty, 
                    HandleStatusUpdate),
                "GitHub" => ServiceProvider.CreateGitHubService(
                    githubInputForm?.Url ?? string.Empty,
                    HandleStatusUpdate),
                "Reddit" => ServiceProvider.CreateRedditService(
                    redditInputForm?.ThreadIds ?? Array.Empty<string>(),
                    HandleStatusUpdate),
                _ => throw new InvalidOperationException("Please select a feedback source")
            };

            var (result, additionalData) = await service.GetFeedback();
            markdownResult = result;

            // Handle specific data formats based on the source type
            if (additionalData is List<YouTubeOutputVideo> videos)
            {
                youtubeVideos = videos;
            }
            else if (selectedSource == "GitHub" && additionalData is List<GithubCommentModel> comments)
            {
                // For single GitHub items, we'll construct a minimal model to display the comments
                var parseResult = GitHubUrlParser.ParseUrl(githubInputForm?.Url ?? string.Empty);
                if (parseResult != null)
                {
                    var (owner, repo, type, number) = parseResult.Value;

                    if (type == "issue" || type == "pull")
                    {
                        githubIssues = new List<GithubIssueModel> 
                        {
                            new()
                            {
                                Id = "single-item",
                                Title = "Comments",
                                Author = "N/A",
                                Body = "",
                                URL = githubInputForm?.Url ?? "",
                                CreatedAt = DateTime.UtcNow,
                                LastUpdated = DateTime.UtcNow,
                                Upvotes = 0,
                                Labels = Array.Empty<string>(),
                                Comments = comments.ToArray()
                            }
                        };
                    }
                    else if (type == "discussion")
                    {
                        githubDiscussions = new List<GithubDiscussionModel>
                        {
                            new()
                            {
                                Title = "Comments",
                                Url = githubInputForm?.Url ?? "",
                                Comments = comments.ToArray()
                            }
                        };
                    }
                }
            }
            else if (additionalData is List<RedditThreadModel> threads)
            {
                redditThreads = threads;
            }
        }
        catch (Exception ex)
        {
            error = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            currentStatusMessage = "";
        }
    }
}
